# Docker Compose for Local Development and Testing

version: '3.8'

services:
  # Main React Application
  app:
    build:
      context: ./chatandvideo
      dockerfile: Dockerfile.dev
    ports:
      - "3000:3000"
    volumes:
      - ./chatandvideo:/app
      - /app/node_modules
    environment:
      - NODE_ENV=development
      - REACT_APP_ENV=development
      - REACT_APP_API_URL=http://localhost:3001
      - REACT_APP_FIREBASE_PROJECT_ID=videochat-dev
      - REACT_APP_FIREBASE_AUTH_DOMAIN=videochat-dev.firebaseapp.com
      - REACT_APP_FIREBASE_DATABASE_URL=https://videochat-dev.firebaseio.com
    networks:
      - videochat-network
    depends_on:
      - firebase-emulator
    command: npm start

  # Firebase Emulator Suite for local testing
  firebase-emulator:
    image: node:18-alpine
    ports:
      - "4000:4000"  # Emulator Suite UI
      - "9099:9099"  # Authentication
      - "8080:8080"  # Cloud Firestore
      - "5001:5001"  # Cloud Functions
      - "9199:9199"  # Database
      - "8085:8085"  # Cloud Pub/Sub
    volumes:
      - ./chatandvideo:/app
      - firebase-data:/app/.firebase
    working_dir: /app
    environment:
      - NODE_ENV=development
    networks:
      - videochat-network
    command: |
      sh -c "
        npm install -g firebase-tools &&
        firebase emulators:start --only auth,firestore,database --project demo-videochat
      "

  # Test Runner for Unit and Integration Tests
  test-runner:
    build:
      context: ./chatandvideo
      dockerfile: Dockerfile.test
    volumes:
      - ./chatandvideo:/app
      - /app/node_modules
      - ./test-results:/app/test-results
    environment:
      - CI=true
      - NODE_ENV=test
      - REACT_APP_ENV=test
    networks:
      - videochat-network
    depends_on:
      - firebase-emulator
    command: npm run test:ci

  # Cypress E2E Testing
  cypress:
    image: cypress/included:13.6.0
    depends_on:
      - app
      - firebase-emulator
    environment:
      - CYPRESS_baseUrl=http://app:3000
      - CYPRESS_video=false
      - CYPRESS_screenshotOnRunFailure=true
    volumes:
      - ./chatandvideo:/e2e
      - ./cypress-results:/e2e/cypress/screenshots
      - ./cypress-results:/e2e/cypress/videos
    working_dir: /e2e
    networks:
      - videochat-network
    command: cypress run

  # Mock API Server for Testing
  mock-api:
    image: node:18-alpine
    ports:
      - "3001:3001"
    volumes:
      - ./test/mock-api:/app
    working_dir: /app
    environment:
      - NODE_ENV=development
    networks:
      - videochat-network
    command: |
      sh -c "
        npm install -g json-server &&
        json-server --watch db.json --host 0.0.0.0 --port 3001
      "

  # Nginx for serving static files in production-like environment
  nginx:
    image: nginx:alpine
    ports:
      - "8080:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./chatandvideo/build:/usr/share/nginx/html
    networks:
      - videochat-network
    depends_on:
      - app

  # Performance testing with Lighthouse CI
  lighthouse:
    image: femtopixel/google-lighthouse
    volumes:
      - ./lighthouse-reports:/home/chrome/reports
    networks:
      - videochat-network
    depends_on:
      - app
    command: lighthouse http://app:3000 --output html --output-path /home/chrome/reports/report.html

  # Database for testing (PostgreSQL alternative for complex tests)
  test-db:
    image: postgres:15-alpine
    environment:
      - POSTGRES_DB=videochat_test
      - POSTGRES_USER=test_user
      - POSTGRES_PASSWORD=test_password
    volumes:
      - test-db-data:/var/lib/postgresql/data
      - ./test/db-init:/docker-entrypoint-initdb.d
    networks:
      - videochat-network
    ports:
      - "5432:5432"

  # Redis for caching and session storage in tests
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    networks:
      - videochat-network
    command: redis-server --appendonly yes

volumes:
  firebase-data:
  test-db-data:
  node_modules:

networks:
  videochat-network:
    driver: bridge
